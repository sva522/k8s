#cloud-config
hostname: k8s1
fqdn: k8s1.lab.ln
manage_etc_hosts: true

# Keep rescue account in image
users:
  - name: admin
    gecos: Bootstrap rescue and automatization
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH0u42ThkDDkM6sPXoCGzgpJ23EiW2fUo0cysnnGWGKr packer@k8s
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /usr/bin/bash
    lock_passwd: false
    # openssl passwd -6 'rescue'
    passwd: $6$B8vK7R25sy.C9ltV$iS0TAhj0.Jl3uNlukNveOaNsh6ItYNemQcPySS0Knr4TE95JRa6RDglwldoKPKTU5OXFz7PFzg./DoOxexSKo0

# SSH configuration
ssh_pwauth: false
disable_root: false

package_update: true
package_upgrade: true
packages:
  - console-setup
  - keyboard-configuration

bootcmd:
  - echo 'This command is executed early during boot (before network)'
  - sysctl -w net.ipv6.conf.all.disable_ipv6=1
  - sysctl -w net.ipv6.conf.default.disable_ipv6=1
  - sysctl -w net.ipv6.conf.lo.disable_ipv6=1

runcmd:
  - echo 'This command is executed once'
  - sed -i 's/XKBLAYOUT=.*/XKBLAYOUT="fr"/' /etc/default/keyboard
  - sed -i 's/XKBVARIANT=.*/XKBVARIANT="oss"/' /etc/default/keyboard
  - dpkg-reconfigure -f noninteractive keyboard-configuration
  - setupcon

# This script is executed on each startup
write_files:
  - path: /var/lib/cloud/scripts/per-boot/hello.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      echo 'Hello from per-boot script at $(date)" >> /var/log/cloud-init-per-boot.log

# This script is executed once
  - path: /var/lib/cloud/scripts/per-instance/setup.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      echo "Setup script (per-instance) at $(date)" >> /var/log/cloud-init-per-instance.log

final_message: "Cloud-init finished successfully."

# Debug with :
# cloud-init schema --system
# and cat /var/log/cloud-init.log | grep -i 'error\|fail'
