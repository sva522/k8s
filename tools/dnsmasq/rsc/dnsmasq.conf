# dnsmasq config for kvm tap interfaces in VM 
# Serves DHCP (fixed IPs by hostname) and acts as DNS for the "lab" domain.
# For unknown queries, forward to 1.1.1.1 and 8.8.8.8 (or to systemd-resolved if you prefer).

# Listen ONLY on the vboxnet interfaces (prevents conflict with host resolv)
# Use interface names exactly as on the host
interface=vm_admin
interface=vm_cni
interface=vm_vsan
interface=vm_svc

# Bind to the interfaces (do not bind to all interfaces)
bind-interfaces

# Which domains this dnsmasq is authoritative for
domain=lab.ln
# Append domain for DHCP clients
dhcp-option=option:domain-search,lab.ln

# DNS forwarding (fallback upstreams)
server=1.1.1.1
server=8.8.8.8
# --- alternatively, to forward to local systemd-resolved stub:
# server=127.0.0.53

# Make dnsmasq not touch /etc/resolv.conf
no-resolv

# We specify range using tag, so that we are allowed to define both range and host on same interface
dhcp-range=tag:vm_admin,192.168.11.100,192.168.11.200,5m
dhcp-range=tag:vm_cni,192.168.12.100,192.168.12.200,5m
dhcp-range=tag:vm_vsan,192.168.13.100,192.168.13.200,5m
dhcp-range=tag:vm_svc,192.168.14.100,192.168.14.200,5m

# No gateway on those network (else set host ip as default gateway)
dhcp-option=tag:vm_admin,option:router
dhcp-option=tag:vm_cni,option:router
dhcp-option=tag:vm_vsan,option:router
dhcp-option=tag:vm_svc,option:router

# ---------- Fixed IPs by hostname (preferred) ----------
# When a host asks for DHCP with hostname "k8s1", it will get 192.168.11.11
# (use DHCP client hostname in the VM). Note: DHCP hostname is what the VM sends.
# Both interfaces may use same domain; choose which interface's subnet to serve.

# For vm_admin (192.168.11.x)
dhcp-host=tag:vm_admin,debian,192.168.11.10,1m
dhcp-host=tag:vm_admin,k8s1,192.168.11.11,5m
dhcp-host=tag:vm_admin,k8s2,192.168.11.12,5m
dhcp-host=tag:vm_admin,k8s3,192.168.11.13,5m

# For vm_cni (192.168.12.x)
dhcp-host=tag:vm_cni,debian,192.168.12.10,1m
dhcp-host=tag:vm_cni,k8s1,192.168.12.11,5m
dhcp-host=tag:vm_cni,k8s2,192.168.12.12,5m
dhcp-host=tag:vm_cni,k8s3,192.168.12.13,5m

# For vm_vsan (192.168.13.x)
dhcp-host=tag:vm_vsan,debian,192.168.13.10,1m
dhcp-host=tag:vm_vsan,k8s1,192.168.13.11,5m
dhcp-host=tag:vm_vsan,k8s2,192.168.13.12,5m
dhcp-host=tag:vm_vsan,k8s3,192.168.13.13,5m

# For vm_svc (192.168.14.x)
dhcp-host=tag:vm_svc,debian,192.168.14.10,1m
dhcp-host=tag:vm_svc,k8s1,192.168.14.11,5m
dhcp-host=tag:vm_svc,k8s2,192.168.14.12,5m
dhcp-host=tag:vm_svc,k8s3,192.168.14.13,5m

# If you prefer to assign by MAC address, uncomment and replace the MACs.
# Example:
# dhcp-host=aa:bb:cc:dd:ee:01,192.168.11.11,k8s1,5m
# dhcp-host=aa:bb:cc:dd:ee:02,192.168.11.12,k8s2,5m
# dhcp-host=aa:bb:cc:dd:ee:03,192.168.11.13,k8s3,5m

# Do not create DNS from DHCP lease because,
# multiple entries (each network) will be created for an hostname
dhcp-ignore-names
no-hosts #  Ignore those in /etc/hosts

# Short name resolution
address=/debian/192.168.11.10
address=/k8s/192.168.11.1
address=/admin/192.168.11.100
address=/k8s1/192.168.11.11
address=/k8s2/192.168.11.12
address=/k8s3/192.168.11.13
address=/svc/192.168.14.1
address=/container-registry/192.168.11.254
address=/dns.vm_admin/192.168.11.254
address=/dns.vm_cni/192.168.12.254
address=/dns.vm_vsan/192.168.13.254
address=/dns.vm_svc/192.168.14.254

# FQDN resolution
address=/debian.lab.ln/192.168.11.10
address=/k8s.lab.ln/192.168.11.1
address=/admin.lab.ln/192.168.11.100
address=/k8s1.lab.ln/192.168.11.11
address=/k8s2.lab.ln/192.168.11.12
address=/k8s3.lab.ln/192.168.11.13
address=/svc.lab.ln/192.168.14.1
address=/container-registry.lab.ln/192.168.11.254
address=/dns.vm_admin.lab.ln/192.168.11.254
address=/dns.vm_cni.lab.ln/192.168.12.254
address=/dns.vm_vsan.lab.ln/192.168.13.254
address=/dns.vm_svc.lab.ln/192.168.14.254

# Reverse DNS (PTR records)
ptr-record=10.11.168.192.in-addr.arpa,debian.lab.ln
ptr-record=1.11.168.192.in-addr.arpa,k8s.lab.ln
ptr-record=100.11.168.192.in-addr.arpa,admin.lab.ln
ptr-record=11.11.168.192.in-addr.arpa,k8s1.lab.ln
ptr-record=12.11.168.192.in-addr.arpa,k8s2.lab.ln
ptr-record=13.11.168.192.in-addr.arpa,k8s3.lab.ln
ptr-record=1.14.168.192.in-addr.arpa,svc.lab.ln
ptr-record=254.11.168.192.in-addr.arpa,dns.vm_admin.lab.ln
ptr-record=254.12.168.192.in-addr.arpa,dns.vm_cni.lab.ln
ptr-record=254.13.168.192.in-addr.arpa,dns.vm_vsan.lab.ln
ptr-record=254.14.168.192.in-addr.arpa,dns.vm_svc.lab.ln

# Wildcard resolutions
address=/.svc.lab.ln/192.168.14.1
address=/.svc/192.168.14.1
address=/.admin.lab.ln/192.168.11.100
address=/.admin/192.168.11.100

leasefile-ro # RAM only
log-facility=/var/log/dnsmasq.log
log-dhcp # DHCP detailed log
log-queries
dhcp-script=/opt/log.sh
